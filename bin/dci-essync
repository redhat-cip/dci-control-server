#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright (C) 2017 Red Hat, Inc
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

from dci import dci_config
from dciclient.v1.api import context
from dciclient.v1.api import file
from dciclient.v1.api import files_events

import atexit
import fcntl
import logging
import sys
import traceback

logging.basicConfig(format='%(asctime)-15s %(message)s')

logger = logging.getLogger()
logger.setLevel(logging.INFO)
stream_handler = logging.StreamHandler(stream=sys.stdout)
stream_handler.setLevel(logging.INFO)
logger.addHandler(stream_handler)

LOG = logging.getLogger(__name__)

from dci.elasticsearch import engine as es_engine


def main(es, dci_context):
    LOG.info('Start Elasticsearch sync')
    last_sequence = es.get_last_sequence(doc_type='logs')

    LOG.info('Current last sequence number: %s' % last_sequence)
    db_current_sequence = last_sequence  + 1

    try:
        for f_event in files_events.iter(dci_context, sequence=db_current_sequence,
                                         limit=512):
            db_file = f_event['file']
            if db_file['mime'] != 'text/plain':
                continue
            db_current_sequence = f_event['event']['id']
            if f_event['event']['action'] == 'create':
                file_content = file.content(dci_context, db_file['id'])
                # if the file doesn't exist it means there is a delete
                # action afterwards, so we can safely ignore it
                if file_content.status_code == 200:
                    db_file['content'] = file_content.content
                    es.index(db_file)
                    LOG.info('event %s, index file id %s' % (db_current_sequence, db_file['id'])) # noqa
            elif f_event['event']['action'] == 'delete':
                es.delete(db_file['id'])
                LOG.info('event %s, delete file id %s' % (db_current_sequence, db_file['id'])) # noqa
    except:
        LOG.error('An error has been encountered')
        LOG.info('New last sequence: %s' % max((db_current_sequence-1), last_sequence))  # noqa
        es.update_sequence(max((db_current_sequence-1), last_sequence))
        traceback.print_exc()
        sys.exit(-1)

    if db_current_sequence > last_sequence:
        LOG.info('New last sequence: %s' % max((db_current_sequence-1), last_sequence))  # noqa
        es.update_sequence(max((db_current_sequence-1), last_sequence))
        files_events.delete(dci_context, last_sequence)

    LOG.info('New last sequence: %s' % max((db_current_sequence-1), last_sequence)) # noqa
    LOG.info('Sync done')


if __name__ == '__main__':
    if len(sys.argv) == 4:
        dci_context = context.build_dci_context(dci_cs_url=sys.argv[1],
                                                dci_login=sys.argv[2],
                                                dci_password=sys.argv[3])
    else:
        dci_context = context.build_dci_context()
    conf = dci_config.generate_conf()
    conf['ES_HOST'] = '10.0.0.13'
    conf['ES_PORT'] = 9200
    es = es_engine.DCIESEngine(es_host=conf['ES_HOST'],
                                      es_port=conf['ES_PORT'],
                                      index='dci', timeout=60)

    # acquire an exclusive file lock
    lock_file = open('/tmp/dci-essync.lock', 'w')
    try:
        fcntl.lockf(lock_file, fcntl.LOCK_EX | fcntl.LOCK_NB)
        # release the lock on exit
        atexit.register(lock_file.close)
        atexit.register(fcntl.lockf, lock_file, fcntl.LOCK_UN)
    except IOError:
        LOG.error('dci-essync instance already running, exit(0)')
        sys.exit(0)
    main(es, dci_context)
    sys.exit(0)
